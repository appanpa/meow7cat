<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>車軌地圖工具箱</title>
    <link rel="icon" href="https://cdn.jsdelivr.net/gh/appanpa/meow7cat/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <!-- GPX parser -->
    <script src="https://unpkg.com/togeojson@0.16.0/dist/togeojson.js"></script>
    <!-- SheetJS for csv/xlsx/xls -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #1f2937;
            color: #f9fafb;
        }
        #map {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 0;
            width: 100vw;
            height: 100vh;
        }
        .sidebar {
            position: fixed;
            left: 0; top: 0; bottom: 0;
            width: 320px;
            background: #232b38;
            border-right: 1px solid #4b5563;
            z-index: 100;
            transition: transform 0.3s, width 0.3s;
            box-shadow: 2px 0 28px #0002;
            display: flex;
            flex-direction: column;
        }
        .sidebar.collapsed {
            width: 60px;
        }
        .sidebar-toggle {
            background: #374151;
            color: #fbbf24;
            border: none;
            border-radius: 0 1.2em 1.2em 0;
            font-size: 1.5rem;
            padding: .3em .6em;
            position: absolute;
            top: 22px; right: -2.2em;
            box-shadow: 0 2px 10px #0002;
            cursor: pointer;
            z-index: 101;
            transition: background .2s;
        }
        .sidebar-toggle:hover { background: #4b5563;}
        .sidebar-content {
            padding: 2.2em 1.2em 1.2em 1.2em;
            overflow-y: auto;
            height: 100%;
            transition: opacity 0.3s;
        }
        .sidebar.collapsed .sidebar-content {
            opacity: 0;
            pointer-events: none;
        }
        .sidebar-header {
            font-size: 1.6em;
            font-weight: 900;
            color: #fff;
            text-align: left;
            margin-bottom: 1.2em;
            letter-spacing: 1px;
        }
        .sidebar section {
            margin-bottom: 1.2em;
        }
        .sidebar section h3 {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: .5em;
            color: #f3f4f6;
        }
        .sidebar input[type="file"], .sidebar input[type="button"], .sidebar button {
            background: #374151;
            color: #fff;
            border: none;
            border-radius: .5em;
            padding: .55em 1em;
            margin-bottom: .5em;
            font-size: 1em;
            cursor: pointer;
            transition: background .2s;
        }
        .sidebar input[type="file"]:hover, .sidebar input[type="button"]:hover, .sidebar button:hover {
            background: #4b5563;
        }
        .floating {
            position: absolute;
            z-index: 120;
            background: #232b38e6;
            border-radius: 1em;
            box-shadow: 0 2px 18px #0003;
            min-width: 160px;
            transition: all .3s;
            padding: 0.5em 0.8em;
        }
        .floating .float-toggle {
            background: #4f46e5;
            color: #ffffff;
            border-radius: .7em;
            border: none;
            font-weight: 700;
            padding: .5em 1em;
            margin-bottom: .2em;
            cursor: pointer;
            transition: background .2s;
            width: 100%;
            text-align: left;
        }
        .floating .float-toggle:hover { background: #4338ca;}
        .floating .float-content { display: none; }
        .floating.open .float-content { display: block; }
        .floating-dashboard { top: 28px; right: 28px; }
        .floating-layer { bottom: 28px; right: 28px; }
        .floating-tools { bottom: 28px; left: 348px; }
        @media (max-width: 800px) {
            .sidebar { width: 84vw; }
            .floating-tools { left: 64px; }
        }
        .modal {
            position: fixed;
            left:0; top:0; right:0; bottom:0;
            background: rgba(31,41,55,0.82);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal.hide { display: none;}
        .modal-content {
            background: #374151;
            color: #f3f4f6;
            border-radius: 1.1em;
            padding: 2em 2.2em 1.5em 2.2em;
            box-shadow: 0 4px 32px #0007;
            min-width: 300px;
            max-width: 96vw;
            min-height: 120px;
            position: relative;
        }
        .modal-close {
            position: absolute;
            right: 1em; top: .8em;
            background: #4f46e5;
            border: none;
            color: #fff;
            border-radius: 999px;
            font-size: 1.1em;
            padding: .2em .7em;
            cursor: pointer;
            transition: background .2s;
        }
        .modal-close:hover { background: #4338ca;}
        .track-label {
            background: #4f46e5;
            color: #fff;
            border-radius: .5em;
            font-size: .9em;
            padding: .15em .55em;
        }
    </style>
</head>
<body>
<div id="map"></div>

<aside id="sidebar" class="sidebar">
    <button class="sidebar-toggle" id="sidebarToggle" title="收合選單"><i class="fa fa-bars"></i></button>
    <div class="sidebar-content">
        <div class="sidebar-header">車軌地圖工具</div>
        <section>
            <h3>步驟一：檔案上傳</h3>
            <input type="file" id="fileUpload" accept=".gpx,.csv,.xlsx,.xls,.json">
            <div id="uploadStatus" style="color:#fbbf24;font-size:.95em;"></div>
        </section>
        <section>
            <h3>步驟二：資料處理</h3>
            <input type="button" value="開始處理" onclick="alert('資料處理功能待實作')">
        </section>
        <section>
            <h3>步驟三：繪製軌跡</h3>
            <input type="button" value="繪製" onclick="alert('繪製功能待實作')">
        </section>
        <hr class="my-3 border-gray-700">
        <button onclick="showModal('preview')"><i class="fa fa-table"></i> 原始資料預覽</button>
        <button onclick="showModal('analysis')"><i class="fa fa-brain"></i> 軌跡智慧分析</button>
    </div>
</aside>

<div class="floating floating-dashboard" id="floatDashboard">
    <button class="float-toggle" onclick="toggleFloat('floatDashboard')"><i class="fa fa-tachometer-alt"></i> 偵查儀錶板</button>
    <div class="float-content">
        <div>速度：---</div>
        <div>距離：---</div>
        <div>時間：---</div>
    </div>
</div>
<div class="floating floating-layer" id="floatLayer">
    <button class="float-toggle" onclick="toggleFloat('floatLayer')"><i class="fa fa-layer-group"></i> 軌跡塗層控制</button>
    <div class="float-content">
        <label><input type="checkbox" checked onchange="toggleTrackLayer(this)"> 顯示主軌跡</label><br>
        <label><input type="checkbox"> 顯示輔助圖層</label>
    </div>
</div>
<div class="floating floating-tools" id="floatTools">
    <button class="float-toggle" onclick="toggleFloat('floatTools')"><i class="fa fa-tools"></i> 軌跡工具</button>
    <div class="float-content">
        <button onclick="alert('測距功能待實作')">測距</button>
        <button onclick="alert('分段功能待實作')">分段</button>
    </div>
</div>

<div id="modal" class="modal hide">
    <div class="modal-content" id="modal-content">
        <button class="modal-close" onclick="hideModal()"><i class="fa fa-times"></i></button>
    </div>
</div>

<script>
// Leaflet 地圖初始化（台灣）
const map = L.map('map').setView([23.8, 121], 7.5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap',
    maxZoom: 19
}).addTo(map);

// 側邊選單收合
const sidebar = document.getElementById('sidebar');
document.getElementById('sidebarToggle').onclick = function(e) {
    sidebar.classList.toggle('collapsed');
    e.stopPropagation();
};

// 懸浮元件收合切換
function toggleFloat(id) {
    var el = document.getElementById(id);
    el.classList.toggle('open');
}

// Modal 彈窗控制
function showModal(type) {
    var modal = document.getElementById('modal');
    var content = document.getElementById('modal-content');
    let html = '';
    if (type === 'preview') {
        html = `<h2>原始資料預覽</h2><div id="previewContent">此處顯示上傳檔案資料內容<br><br><em>（功能待實作）</em></div>`;
    }
    if (type === 'analysis') {
        html = `<h2>軌跡智慧分析</h2><div>此處顯示分析結果<br><br><em>（功能待實作）</em></div>`;
    }
    content.innerHTML = html + content.innerHTML.match(/<button class="modal-close"/);
    modal.classList.remove('hide');
}
function hideModal() {
    document.getElementById('modal').classList.add('hide');
}

// 軌跡圖層
let trackLayer = null;
function toggleTrackLayer(cb) {
    if (cb.checked) {
        if (trackLayer) map.addLayer(trackLayer);
    } else {
        if (trackLayer) map.removeLayer(trackLayer);
    }
}

// 檔案上傳與解析
document.getElementById('fileUpload').addEventListener('change', function(e){
    const file = e.target.files[0];
    if (!file) return;
    const status = document.getElementById('uploadStatus');
    status.textContent = '檔案上傳中...';

    const ext = file.name.split('.').pop().toLowerCase();
    // GPX
    if (ext === 'gpx') {
        const reader = new FileReader();
        reader.onload = function(evt){
            let geojson = null;
            try {
                const domparser = new DOMParser();
                const xml = domparser.parseFromString(evt.target.result, "application/xml");
                geojson = toGeoJSON.gpx(xml);
            } catch (err) {
                status.textContent = 'GPX解析失敗';
                return;
            }
            drawTrackFromGeoJSON(geojson, file.name, status);
        };
        reader.readAsText(file);
        return;
    }
    // CSV/XLSX/XLS
    if (['csv','xlsx','xls'].includes(ext)) {
        const reader = new FileReader();
        reader.onload = function(evt){
            let data = evt.target.result;
            let workbook, sheet, rows = [];
            try {
                if (ext === 'csv') {
                    workbook = XLSX.read(data, {type:'string'});
                } else {
                    workbook = XLSX.read(data, {type:'array'});
                }
                sheet = workbook.Sheets[workbook.SheetNames[0]];
                rows = XLSX.utils.sheet_to_json(sheet, {header:1});
            } catch (err) {
                status.textContent = '檔案解析失敗';
                return;
            }
            // 尋找經緯度欄位
            let header = rows[0].map(h=>h.toString().toLowerCase());
            let latIdx = header.findIndex(h=>(h==='lat'||h==='latitude'||h==='y'||h==='緯度'));
            let lngIdx = header.findIndex(h=>(h==='lng'||h==='lon'||h==='longitude'||h==='x'||h==='經度'));
            if (latIdx === -1 || lngIdx === -1) {
                status.textContent = '找不到經緯度欄位（欄名需為 lat/lng 或 latitude/longitude 或 x/y 或 經度/緯度）';
                return;
            }
            let coords = [];
            for(let i=1;i<rows.length;i++){
                let lat = parseFloat(rows[i][latIdx]);
                let lng = parseFloat(rows[i][lngIdx]);
                if(!isNaN(lat) && !isNaN(lng)) coords.push([lat,lng]);
            }
            if(coords.length<2){
                status.textContent = '座標點不足';
                return;
            }
            drawTrackFromLatLngs(coords, file.name, status);
        };
        if (ext==='csv') reader.readAsText(file);
        else reader.readAsArrayBuffer(file);
        return;
    }
    // JSON（假設是GeoJSON）
    if (ext === 'json') {
        const reader = new FileReader();
        reader.onload = function(evt){
            let geojson;
            try {
                geojson = JSON.parse(evt.target.result);
            } catch (err) {
                status.textContent = 'JSON解析失敗';
                return;
            }
            drawTrackFromGeoJSON(geojson, file.name, status);
        };
        reader.readAsText(file);
        return;
    }
    status.textContent = '不支援的檔案類型';
});

// GPX/GeoJSON繪製
function drawTrackFromGeoJSON(geojson, filename, status) {
    if (!geojson || !geojson.features) {
        status.textContent = '檔案無有效軌跡資料';
        return;
    }
    let coords = [];
    geojson.features.forEach(f=>{
        if (f.geometry.type === 'LineString') {
            coords = coords.concat(f.geometry.coordinates.map(c=>[c[1],c[0]]));
        }
        if (f.geometry.type === 'MultiLineString') {
            f.geometry.coordinates.forEach(arr=>{
                coords = coords.concat(arr.map(c=>[c[1],c[0]]));
            });
        }
    });
    if (coords.length<2) {
        status.textContent = '無有效軌跡座標';
        return;
    }
    drawTrackFromLatLngs(coords, filename, status);
}

// 通用繪製
function drawTrackFromLatLngs(latlngs, filename, status) {
    if (trackLayer) map.removeLayer(trackLayer);
    trackLayer = L.polyline(latlngs, {color:'#4f46e5',weight:5,opacity:0.87}).addTo(map);
    map.fitBounds(trackLayer.getBounds());
    status.textContent = '已繪製軌跡 ('+latlngs.length+'點)';

    // 原始資料預覽
    let preview = document.getElementById('previewContent');
    if (preview) {
        let html = '<table style="width:100%;font-size:.95em;"><tr><th>#</th><th>緯度</th><th>經度</th></tr>';
        latlngs.slice(0,20).forEach((p,i)=>{
            html += `<tr><td>${i+1}</td><td>${p[0].toFixed(6)}</td><td>${p[1].toFixed(6)}</td></tr>`;
        });
        if(latlngs.length>20) html += `<tr><td colspan=3>...共${latlngs.length}點</td></tr>`;
        html += '</table>';
        preview.innerHTML = html;
    }
}
</script>
</body>
</html>
