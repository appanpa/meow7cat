<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>車軌地圖工具箱</title>
<meta name="robots" content="noindex, nofollow">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/togeojson@0.16.0/dist/togeojson.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/leaflet-arrowheads@1.0.3/dist/leaflet-arrowheads.min.js"></script>
<style>
html,body{height:100%;margin:0;font-family:'Inter','Noto Sans TC',sans-serif;background:#1f2937;color:#f9fafb;}
#map{position:absolute;top:0;left:0;right:0;bottom:0;z-index:0;width:100vw;height:100vh;}
/* Sidebar優化 */
.sidebar{position:fixed;left:0;top:0;bottom:0;width:310px;background:#232b38;border-right:1px solid #4b5563;z-index:100;transition:width 0.3s;box-shadow:2px 0 28px #0002;display:flex;flex-direction:column;}
.sidebar.collapsed{width:56px;}
.sidebar-toggle{position:absolute;top:16px;left:10px;z-index:102;background:#2d2f3a;border:none;color:#fbbf24;font-size:1.7em;padding:.2em .5em;border-radius:999px;box-shadow:0 2px 10px #0002;cursor:pointer;transition:background .2s;}
.sidebar-toggle:hover{background:#4b5563;}
.sidebar-content{padding:2.2em 1.2em 1.2em 1.2em;overflow-y:auto;height:100%;transition:opacity 0.3s;}
.sidebar.collapsed .sidebar-content{opacity:0;pointer-events:none;}
.sidebar-header{font-size:1.6em;font-weight:900;color:#fff;text-align:left;margin-bottom:1.2em;letter-spacing:1px;}
.sidebar section{margin-bottom:1.2em;}
.sidebar section h3{font-size:1.1rem;font-weight:700;margin-bottom:.5em;color:#f3f4f6;}
.sidebar input[type="file"],.sidebar select,.sidebar input[type="button"],.sidebar button{background:#374151;color:#fff;border:none;border-radius:.5em;padding:.55em 1em;margin-bottom:.5em;font-size:1em;cursor:pointer;transition:background .2s;}
.sidebar input[type="file"]:hover,.sidebar input[type="button"]:hover,.sidebar button:hover,.sidebar select:hover{background:#4b5563;}
.track-panel{background:#232b38;border-radius:.7em;padding:.8em .8em .5em .8em;margin-bottom:.9em;}
.track-panel label{font-weight:600;font-size:1.02em;display:block;margin-bottom:.4em;}
.track-panel .track-date-list{margin-bottom:.8em;}
.track-panel .date-item{margin-right:1em;margin-bottom:.3em;display:inline-block;}
.track-panel .track-toggle-all{margin-bottom:.7em;}
.track-panel .track-toggle-all input[type=checkbox]{transform:scale(1.2);margin-right:.25em;}
.track-panel .track-toggle-all{font-weight:700;}
@media (max-width:800px){.sidebar{width:84vw;}}
.track-marker{background:#4f46e5;color:#fff;border-radius:.5em;font-size:.95em;padding:.2em .6em;border:2px solid #fff;font-weight:700;}
.arrowhead{stroke:#4338ca !important;}
/* 懸浮區域優化 */
.floating{position:fixed;z-index:120;transition:all .3s;}
.floating .float-btn{background:#31324b;color:#fff;border:none;border-radius:999px;width:46px;height:46px;box-shadow:0 2px 10px #0003;display:flex;align-items:center;justify-content:center;font-size:1.7em;cursor:pointer;transition:background .2s;}
.floating .float-btn:hover{background:#4b5563;}
.floating-panel{background:#232b38ee;border-radius:1.1em;box-shadow:0 2px 18px #0003;min-width:180px;padding:1em 1.2em;display:none;flex-direction:column;}
.floating.open .floating-panel{display:flex;animation:fadeIn .3s;}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
.floating-dashboard{top:32px;right:32px;}
.floating-layer{bottom:32px;right:32px;}
.floating-tools{bottom:32px;left:64px;}
@media (max-width:800px){.floating-tools{left:12px;}}
</style>
</head>
<body>
<div id="map"></div>

<!-- 左側選單 -->
<aside id="sidebar" class="sidebar">
    <button class="sidebar-toggle" id="sidebarToggle" title="收合選單"><i class="fa fa-bars"></i></button>
    <div class="sidebar-content">
        <div class="sidebar-header">車軌地圖工具</div>
        <section>
            <h3>步驟一：檔案上傳</h3>
            <input type="file" id="fileUpload" accept=".gpx,.csv,.xlsx,.xls,.json">
            <div id="uploadStatus" style="color:#fbbf24;font-size:.95em;"></div>
            <div id="fieldSelector"></div>
        </section>
        <section id="trackControlPanel" style="display:none;">
            <h3>軌跡圖層控制</h3>
            <div class="track-panel" id="trackPanel"></div>
        </section>
        <hr class="my-3 border-gray-700">
        <button onclick="showModal('preview')"><i class="fa fa-table"></i> 原始資料預覽</button>
        <button onclick="showModal('analysis')"><i class="fa fa-brain"></i> 軌跡智慧分析</button>
        <button id="btnGoogleRoute" style="display:none;margin-top:.9em;"><i class="fa fa-location-arrow"></i> 預測行車路線 (Google Maps)</button>
    </div>
</aside>

<!-- 懸浮式 儀表板 右上 -->
<div class="floating floating-dashboard" id="floatDashboard">
    <button class="float-btn" title="偵查儀表板" onclick="toggleFloat('floatDashboard')"><i class="fa fa-tachometer-alt"></i></button>
    <div class="floating-panel">
        <div style="font-size:1.1em;font-weight:700;margin-bottom:.5em;">偵查儀表板</div>
        <div>速度：---</div>
        <div>距離：---</div>
        <div>時間：---</div>
    </div>
</div>
<!-- 懸浮式 塗層控制 右下 -->
<div class="floating floating-layer" id="floatLayer">
    <button class="float-btn" title="軌跡塗層控制" onclick="toggleFloat('floatLayer')"><i class="fa fa-layer-group"></i></button>
    <div class="floating-panel">
        <div style="font-size:1.1em;font-weight:700;margin-bottom:.5em;">軌跡塗層控制</div>
        <label><input type="checkbox" checked onchange="toggleTrackLayer(this)"> 顯示主軌跡</label><br>
        <label><input type="checkbox"> 顯示輔助圖層</label>
    </div>
</div>
<!-- 懸浮式 軌跡工具 左下 -->
<div class="floating floating-tools" id="floatTools">
    <button class="float-btn" title="軌跡工具" onclick="toggleFloat('floatTools')"><i class="fa fa-tools"></i></button>
    <div class="floating-panel">
        <div style="font-size:1.1em;font-weight:700;margin-bottom:.5em;">軌跡工具</div>
        <button onclick="alert('測距功能待實作')">測距</button>
        <button onclick="alert('分段功能待實作')">分段</button>
    </div>
</div>

<!-- 彈窗 Modal -->
<div id="modal" class="modal hide">
    <div class="modal-content" id="modal-content">
        <button class="modal-close" onclick="hideModal()"><i class="fa fa-times"></i></button>
    </div>
</div>

<script>
// Leaflet 地圖初始化（台灣）
const map = L.map('map').setView([23.8, 121], 7.5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap',
    maxZoom: 19
}).addTo(map);

// 左側選單收合優化
const sidebar = document.getElementById('sidebar');
document.getElementById('sidebarToggle').onclick = function(e) {
    sidebar.classList.toggle('collapsed');
    e.stopPropagation();
};

// 右側懸浮式功能區收合展開
function toggleFloat(id){
    let el = document.getElementById(id);
    el.classList.toggle('open');
    // 只允許展開一個
    ['floatDashboard','floatLayer','floatTools'].forEach(x=>{
        if(x!==id) document.getElementById(x).classList.remove('open');
    });
}

// 彈窗
function showModal(type) {
    var modal = document.getElementById('modal');
    var content = document.getElementById('modal-content');
    let html = '';
    if (type === 'preview') {
        html = `<h2>原始資料預覽</h2><div id="previewContent"></div>`;
    }
    if (type === 'analysis') {
        html = `<h2>軌跡智慧分析</h2><div>此處顯示分析結果<br><br><em>（功能待實作）</em></div>`;
    }
    content.innerHTML = html + content.innerHTML.match(/<button class="modal-close"/);
    modal.classList.remove('hide');
}
function hideModal() {
    document.getElementById('modal').classList.add('hide');
}

// 資料變數（同原本）
let parsedRows = [];
let parsedHeader = [];
let timeCol = null, latCol = null, lngCol = null;
let allTracks = {}; // date: [rows]
let trackLayers = {}; // date: {poly, markers}
let trackOrder = [];
let trackColorSet = ['#4f46e5','#e11d48','#22d3ee','#fbbf24','#84cc16','#f472b6','#818cf8'];

// 支援欄位自動偵測
function autoDetectCols(header) {
    let timeIdx = header.findIndex(h => /time|時間/i.test(h));
    let latIdx = header.findIndex(h => /lat|latitude|y|緯度/i.test(h));
    let lngIdx = header.findIndex(h => /lng|lon|longitude|x|經度/i.test(h));
    return { time: timeIdx, lat: latIdx, lng: lngIdx };
}

// 檔案上傳與解析（同原本）

// 欄位選擇介面（同原本）

// 分組、繪製主控（同原本）
function drawTracks() {
    let ct = document.getElementById('colTime').value;
    let clat = document.getElementById('colLat').value;
    let clng = document.getElementById('colLng').value;
    timeCol = parsedHeader[ct];
    latCol = parsedHeader[clat];
    lngCol = parsedHeader[clng];
    allTracks = {}; trackOrder = [];
    parsedRows.forEach((row, i)=>{
        let t = row[timeCol];
        let d = t ? (t.toString().slice(0,10)) : '未知日期';
        if (!allTracks[d]) { allTracks[d]=[]; trackOrder.push(d);}
        allTracks[d].push(row);
    });
    // 依時間排序，每天資料編號
    trackOrder.forEach(date => {
      let rows = allTracks[date];
      rows.sort((a, b) => new Date(a[timeCol]) - new Date(b[timeCol]));
      rows.forEach((row, idx) => row._track_idx = idx + 1);
    });
    // 清除原本軌跡
    Object.values(trackLayers).forEach(obj=>{
        if(obj.poly) map.removeLayer(obj.poly);
        if(obj.markers) obj.markers.forEach(m=>map.removeLayer(m));
    });
    trackLayers = {};
    // 繪製每日期的軌跡
    trackOrder.forEach((d,idx)=>{
        let color = trackColorSet[idx%trackColorSet.length];
        let rows = allTracks[d].filter(pt=>!isNaN(pt[latCol])&&!isNaN(pt[lngCol]));
        if(rows.length<2) return;
        let latlngs = rows.map(pt=>[pt[latCol],pt[lngCol]]);
        let poly = L.polyline(latlngs, {color:color,weight:5,opacity:0.87}).addTo(map);
        poly.arrowheads({size:'10px',yawn:50,frequency:'endonly',color:color});
        let markers = rows.map((pt,i)=>{
            let marker = L.marker([pt[latCol],pt[lngCol]],{
                icon:L.divIcon({
                    className:'track-marker',
                    html:`${pt._track_idx}`,
                    iconSize:[30,30]
                })
            }).addTo(map);
            marker.bindPopup(`<div style="font-size:.97em;"><b>編號:</b> ${pt._track_idx}<br>${
                parsedHeader.map(h=>`<b>${h}:</b> ${pt[h]??''}`).join('<br>')
            }</div>`);
            marker.on('mouseover',function(){marker.openPopup();});
            marker.on('mouseout',function(){marker.closePopup();});
            return marker;
        });
        trackLayers[d] = {poly,markers};
    });
    updateTrackPanel();
    document.getElementById('btnGoogleRoute').style.display = '';
    document.getElementById('trackControlPanel').style.display = '';
    fitTracks();
}

// 軌跡圖層控制面板（同原本）
function updateTrackPanel(){
    const panel = document.getElementById('trackPanel');
    let html = `<div class="track-toggle-all">
        <input type="checkbox" id="chkAllTracks" checked onchange="toggleAllTracks(this)">
        <label for="chkAllTracks">顯示/隱藏所有軌跡</label>
    </div><div class="track-date-list">`;
    trackOrder.forEach((d,idx)=>{
        html += `<span class="date-item">
            <input type="checkbox" id="chkTrack${idx}" checked onchange="toggleTrack('${d}',this)">
            <label for="chkTrack${idx}" style="color:${trackColorSet[idx%trackColorSet.length]};">${d}</label>
        </span>`;
    });
    html += `</div>`;
    panel.innerHTML = html;
    // 預設全部加到地圖
    trackOrder.forEach((d,idx)=>{
        let obj = trackLayers[d];
        if(obj){
            map.addLayer(obj.poly);
            obj.markers.forEach(m=>map.addLayer(m));
        }
    });
}

// 全選/全不選
function toggleAllTracks(cb){
    trackOrder.forEach((d,idx)=>{
        let el = document.getElementById('chkTrack'+idx);
        el.checked = cb.checked;
        toggleTrack(d,el);
    });
    fitTracks();
}

// 個別日期顯示/隱藏
function toggleTrack(date,cb){
    let idx = trackOrder.indexOf(date);
    let obj = trackLayers[date];
    if(!obj)return;
    if(cb.checked){
        map.addLayer(obj.poly);
        obj.markers.forEach(m=>map.addLayer(m));
    }else{
        map.removeLayer(obj.poly);
        obj.markers.forEach(m=>map.removeLayer(m));
    }
    fitTracks();
}

// 智慧視野
function fitTracks(){
    let bounds = null;
    trackOrder.forEach((d,idx)=>{
        let cb = document.getElementById('chkTrack'+idx);
        if(cb && cb.checked && trackLayers[d]){
            let b = trackLayers[d].poly.getBounds();
            bounds = bounds ? bounds.extend(b) : b;
        }
    });
    if(bounds) map.fitBounds(bounds,{padding:[24,24]});
}

// Google Maps 路線規劃
document.getElementById('btnGoogleRoute').onclick = function(){
    let pts=[];
    trackOrder.forEach((d,idx)=>{
        let cb = document.getElementById('chkTrack'+idx);
        if(cb && cb.checked && allTracks[d]){
            allTracks[d].forEach(pt=>{
                let lat = pt[latCol], lng = pt[lngCol];
                if(!isNaN(lat)&&!isNaN(lng)){
                    pts.push({lat:lat,lng:lng});
                }
            });
        }
    });
    if(pts.length<2){alert('請先選擇至少兩個點！');return;}
    let origin = `${pts[0].lat},${pts[0].lng}`;
    let destination = `${pts[pts.length-1].lat},${pts[pts.length-1].lng}`;
    let waypoints = pts.slice(1,-1).map(pt=>`${pt.lat},${pt.lng}`).join('|');
    let url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}`;
    if(waypoints) url += `&waypoints=${waypoints}`;
    window.open(url,'_blank');
};

// 懸浮式塗層控制 checkbox demo
function toggleTrackLayer(cb){
    alert('此功能可自行擴充，主軌跡可用左側面板控制');
}
</script>
</body>
</html>
