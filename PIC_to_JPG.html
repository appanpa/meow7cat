
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¶²é ç‰ˆåœ–ç‰‡æ‰¹æ¬¡è½‰æª”å·¥å…· (PNG/HEIC/JPG)</title>
    <!-- å¼•å…¥ Tailwind CSS ä»¥å¿«é€Ÿç¾åŒ–é é¢ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ JSZip ç”¨æ–¼æ‰“åŒ…æª”æ¡ˆ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- å¼•å…¥ heic2any ç”¨æ–¼è½‰æ› HEIC æª”æ¡ˆ -->
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <style>
        /* ä½¿ç”¨ Google Fonts çš„ 'Noto Sans TC' å­—é«”ä»¥ç²å¾—æ›´å¥½çš„ä¸­æ–‡é¡¯ç¤ºæ•ˆæœ */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        /* è®“æª”æ¡ˆé¸æ“‡æŒ‰éˆ•çœ‹èµ·ä¾†æ›´åƒä¸€å€‹å¤§æŒ‰éˆ• */
        #file-input-label {
            cursor: pointer;
            display: block;
            padding: 0.75rem 1.5rem;
            border: 2px dashed #9ca3af;
            transition: all 0.3s ease;
        }
        #file-input-label:hover {
            border-color: #3b82f6;
            background-color: #f9fafb;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl p-6 sm:p-8 space-y-6 bg-white rounded-xl shadow-lg">
        <div class="text-center">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">åœ–ç‰‡æ‰¹æ¬¡è½‰æª”å£“ç¸®å·¥å…·</h1>
            <p class="text-gray-500 mt-2">å°‡ PNG / HEIC / JPG è½‰ç‚ºè¼•é‡åŒ–çš„ JPG æª”æ¡ˆ</p>
        </div>

        <!-- æ­¥é©Ÿä¸€ï¼šé¸æ“‡æª”æ¡ˆ -->
        <div>
            <h2 class="text-lg font-semibold text-gray-700 mb-2">1. é¸æ“‡åœ–ç‰‡æª”æ¡ˆ</h2>
            <input type="file" id="fileInput" multiple accept="image/png,image/jpeg,image/heic,.heic" class="hidden">
            <label for="fileInput" id="file-input-label" class="text-center text-gray-600 rounded-lg">
                é»æ“Šæ­¤è™•é¸æ“‡æª”æ¡ˆï¼Œæˆ–å°‡æª”æ¡ˆæ‹–æ›³è‡³æ­¤<br>
                <span id="file-count" class="text-sm font-medium text-blue-600">ï¼ˆå°šæœªé¸æ“‡æª”æ¡ˆï¼‰</span>
            </label>
        </div>

        <!-- æ­¥é©ŸäºŒï¼šè¨­å®š -->
        <div>
            <h2 class="text-lg font-semibold text-gray-700 mb-2">2. è¨­å®šé¸é …</h2>
            <div class="space-y-3">
                <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                    <label for="enable-compression" class="font-medium text-gray-700">å•Ÿç”¨åœ–ç‰‡å£“ç¸®</label>
                    <input type="checkbox" id="enable-compression" class="h-6 w-6 rounded text-blue-600 focus:ring-blue-500 border-gray-300">
                </div>
                <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                    <label for="compression-limit" class="font-medium text-gray-700">å£“ç¸®å¤§å°ä¸Šé™ (MB)</label>
                    <input type="number" id="compression-limit" value="2" class="w-24 text-center border border-gray-300 rounded-md p-1 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
        </div>

        <!-- æ­¥é©Ÿä¸‰ï¼šé–‹å§‹è½‰æ› -->
        <div>
            <button id="start-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed">
                é–‹å§‹è½‰æ›
            </button>
        </div>

        <!-- é€²åº¦èˆ‡æ—¥èªŒ -->
        <div class="space-y-4">
            <div id="progress-container" class="hidden">
                <div class="flex justify-between mb-1">
                    <span class="text-base font-medium text-gray-700">è½‰æ›é€²åº¦</span>
                    <span id="progress-label" class="text-sm font-medium text-gray-700">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
            <div id="log-container" class="hidden">
                 <h3 class="text-md font-semibold text-gray-700">è™•ç†æ—¥èªŒï¼š</h3>
                 <div id="log-text" class="w-full h-40 bg-gray-900 text-white text-sm font-mono p-3 rounded-lg overflow-y-auto"></div>
            </div>
            <div id="download-container" class="hidden text-center">
                <a id="download-link" class="inline-block bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 shadow-lg">
                    ä¸‹è¼‰è½‰æ›å¾Œçš„ ZIP æª”æ¡ˆ
                </a>
            </div>
        </div>
    </div>

<script>
// --- DOM å…ƒç´  ---
const fileInput = document.getElementById('fileInput');
const fileInputLabel = document.getElementById('file-input-label');
const fileCount = document.getElementById('file-count');
const enableCompression = document.getElementById('enable-compression');
const compressionLimit = document.getElementById('compression-limit');
const startButton = document.getElementById('start-button');
const progressContainer = document.getElementById('progress-container');
const progressBar = document.getElementById('progress-bar');
const progressLabel = document.getElementById('progress-label');
const logContainer = document.getElementById('log-container');
const logText = document.getElementById('log-text');
const downloadContainer = document.getElementById('download-container');
const downloadLink = document.getElementById('download-link');

let selectedFiles = [];

// --- äº‹ä»¶ç›£è½å™¨ ---
fileInput.addEventListener('change', (e) => {
    selectedFiles = Array.from(e.target.files);
    fileCount.textContent = `ï¼ˆå·²é¸æ“‡ ${selectedFiles.length} å€‹æª”æ¡ˆï¼‰`;
    if (selectedFiles.length > 0) {
        downloadContainer.classList.add('hidden'); // å¦‚æœé‡æ–°é¸æ“‡æª”æ¡ˆï¼Œéš±è—èˆŠçš„ä¸‹è¼‰é€£çµ
    }
});

startButton.addEventListener('click', startConversion);

// --- æ ¸å¿ƒå‡½å¼ ---

/**
 * é–‹å§‹è½‰æ›æµç¨‹çš„ä¸»å‡½å¼
 */
async function startConversion() {
    if (selectedFiles.length === 0) {
        alert("è«‹å…ˆé¸æ“‡è¦è½‰æ›çš„åœ–ç‰‡æª”æ¡ˆã€‚");
        return;
    }

    // ç²å–è¨­å®š
    const settings = {
        limitSize: enableCompression.checked,
        // å°‡ MB è½‰æ›ç‚º Bytes
        limitBytes: parseFloat(compressionLimit.value) * 1024 * 1024
    };

    if (settings.limitSize && (isNaN(settings.limitBytes) || settings.limitBytes <= 0)) {
        alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„å£“ç¸®å¤§å°é™åˆ¶ (MB)ã€‚");
        return;
    }

    // é‡ç½® UI
    startButton.disabled = true;
    startButton.textContent = "è½‰æ›ä¸­...";
    progressContainer.classList.remove('hidden');
    logContainer.classList.remove('hidden');
    downloadContainer.classList.add('hidden');
    logText.innerHTML = '';
    updateProgress(0);

    const zip = new JSZip();
    const totalFiles = selectedFiles.length;

    log("ğŸš€ é–‹å§‹æ‰¹æ¬¡è½‰æ›...");

    for (let i = 0; i < totalFiles; i++) {
        const file = selectedFiles[i];
        const baseName = file.name.substring(0, file.name.lastIndexOf('.'));
        const outputFilename = `${baseName}.jpg`;
        
        log(`\nğŸ“„ æ­£åœ¨è™•ç†: ${file.name}`);

        try {
            const resultBlob = await processFile(file, settings);
            zip.file(outputFilename, resultBlob);
        } catch (error) {
            log(`âŒ è™•ç†å¤±æ•—: ${file.name} - ${error.message}`);
        }
        
        updateProgress(((i + 1) / totalFiles) * 100);
    }

    log("\nâœ… æ‰€æœ‰æª”æ¡ˆè™•ç†å®Œç•¢ï¼Œæ­£åœ¨æ‰“åŒ… ZIP...");

    // ç”Ÿæˆä¸¦æä¾› ZIP ä¸‹è¼‰
    zip.generateAsync({ type: "blob" })
        .then(function(content) {
            const url = URL.createObjectURL(content);
            downloadLink.href = url;
            downloadLink.download = "converted_images.zip";
            downloadContainer.classList.remove('hidden');
            log("ğŸ“¦ ZIP æª”æ¡ˆå·²æº–å‚™å°±ç·’ï¼Œå¯ä»¥ä¸‹è¼‰äº†ï¼");
        });

    startButton.disabled = false;
    startButton.textContent = "é–‹å§‹è½‰æ›";
}

/**
 * è™•ç†å–®ä¸€æª”æ¡ˆçš„è½‰æ›èˆ‡å£“ç¸®
 * @param {File} file - ä½¿ç”¨è€…é¸æ“‡çš„æª”æ¡ˆ
 * @param {object} settings - è½‰æ›è¨­å®š
 * @returns {Promise<Blob>} - è™•ç†å®Œæˆçš„ JPG Blob ç‰©ä»¶
 */
async function processFile(file, settings) {
    const originalSize = file.size;
    let blob = file;

    // å¦‚æœæ˜¯ HEICï¼Œå…ˆç”¨ heic2any è½‰æ›
    if (file.type.includes('heic') || file.name.toLowerCase().endsWith('.heic')) {
        log("ğŸ” åµæ¸¬åˆ° HEIC æª”æ¡ˆï¼Œé€²è¡Œé è½‰æ›...");
        blob = await heic2any({ blob: file, toType: "image/jpeg", quality: 0.95 });
    }

    // è®€å–åœ–ç‰‡è³‡æ–™
    const image = await createImage(blob);
    
    // å¦‚æœä¸éœ€è¦å£“ç¸®ï¼Œç›´æ¥è½‰æ›ç‚º JPG
    if (!settings.limitSize) {
        const resultBlob = await canvasToBlob(image, 'image/jpeg', 0.95);
        const finalSize = resultBlob.size;
        const ratio = finalSize / originalSize;
        log(`âœ… è½‰æ›: ${file.name} â†’ ${Math.round(finalSize/1024)}KB (${Math.round(ratio*100)}%)`);
        return resultBlob;
    }

    // åŸ·è¡Œå£“ç¸®é‚è¼¯
    log(`ğŸ—œï¸ åŸ·è¡Œå£“ç¸®ï¼Œç›®æ¨™å¤§å° < ${compressionLimit.value} MB...`);
    let width = image.width;
    let height = image.height;
    const minSize = 100; // æœ€å°å°ºå¯¸

    while (width > minSize && height > minSize) {
        const tempImage = await createImageFromCanvas(image, width, height);
        for (let q = 95; q >= 10; q -= 5) {
            const quality = q / 100;
            const resultBlob = await canvasToBlob(tempImage, 'image/jpeg', quality);
            if (resultBlob.size <= settings.limitBytes) {
                const finalSize = resultBlob.size;
                const ratio = finalSize / originalSize;
                log(`âœ… è½‰æ›å£“ç¸®: ${file.name} â†’ å“è³ª ${q}% â†’ ${Math.round(finalSize/1024)}KB (${Math.round(ratio*100)}%)`);
                return resultBlob;
            }
        }
        // å¦‚æœæ‰€æœ‰å“è³ªéƒ½å¤±æ•—ï¼Œå‰‡ç¸®å°åœ–ç‰‡å°ºå¯¸
        width = Math.floor(width * 0.9);
        height = Math.floor(height * 0.9);
        log(`ğŸ“ å£“ç¸®æœªé”æ¨™ï¼Œç¸®å°å°ºå¯¸è‡³ ${width}x${height} å¾Œé‡è©¦...`);
    }

    // å¦‚æœå¾ªç’°çµæŸä»æœªæˆåŠŸï¼Œä½¿ç”¨æœ€ä½å“è³ªå„²å­˜
    log(`âš ï¸ ç„¡æ³•å£“ç¸®åˆ°ç›®æ¨™å¤§å°ï¼Œä½¿ç”¨æœ€ä½å“è³ªå„²å­˜ã€‚`);
    const finalBlob = await canvasToBlob(image, 'image/jpeg', 0.20);
    const finalSize = finalBlob.size;
    const ratio = finalSize / originalSize;
    log(`âš ï¸ æœ€å°å£“ç¸®: ${file.name} â†’ ${Math.round(finalSize/1024)}KB (${Math.round(ratio*100)}%)`);
    return finalBlob;
}


// --- è¼”åŠ©å‡½å¼ ---

/**
 * å°‡ Blob æˆ– File ç‰©ä»¶è½‰æ›ç‚º Image å…ƒç´ 
 * @param {Blob|File} blob - åœ–ç‰‡çš„ Blob æˆ– File ç‰©ä»¶
 * @returns {Promise<HTMLImageElement>}
 */
function createImage(blob) {
    return new Promise((resolve, reject) => {
        const url = URL.createObjectURL(blob);
        const img = new Image();
        img.onload = () => {
            URL.revokeObjectURL(url);
            resolve(img);
        };
        img.onerror = (err) => {
            URL.revokeObjectURL(url);
            reject(err);
        };
        img.src = url;
    });
}

/**
 * å°‡ä¸€å€‹ Image å…ƒç´ ç¹ªè£½åˆ°ä¸€å€‹æ–°çš„ã€æŒ‡å®šå°ºå¯¸çš„ Canvas ä¸Šï¼Œä¸¦è¿”å›è©² Canvas ä¸Šçš„ Image
 * @param {HTMLImageElement} originalImage - åŸå§‹åœ–ç‰‡
 * @param {number} width - ç›®æ¨™å¯¬åº¦
 * @param {number} height - ç›®æ¨™é«˜åº¦
 * @returns {Promise<HTMLImageElement>}
 */
async function createImageFromCanvas(originalImage, width, height) {
    const canvas = document.createElement('canvas');
    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(originalImage, 0, 0, width, height);
    
    // å°‡ canvas è½‰å› Image å…ƒç´ ï¼Œç¢ºä¿å¾ŒçºŒæ“ä½œä¸€è‡´
    return await createImage(await canvasToBlob(canvas));
}

/**
 * å°‡ Canvas æˆ– Image å…ƒç´ è½‰æ›ç‚º Blob ç‰©ä»¶
 * @param {HTMLCanvasElement|HTMLImageElement} element - ä¾†æºå…ƒç´ 
 * @param {string} [type='image/jpeg'] - è¼¸å‡ºé¡å‹
 * @param {number} [quality=0.92] - åœ–ç‰‡å“è³ª (0-1)
 * @returns {Promise<Blob>}
 */
function canvasToBlob(element, type = 'image/jpeg', quality = 0.92) {
    const canvas = document.createElement('canvas');
    canvas.width = element.width;
    canvas.height = element.height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(element, 0, 0);
    return new Promise(resolve => canvas.toBlob(resolve, type, quality));
}

/**
 * æ›´æ–°é€²åº¦æ¢
 * @param {number} percent - ç™¾åˆ†æ¯”
 */
function updateProgress(percent) {
    const p = Math.round(percent);
    progressBar.style.width = `${p}%`;
    progressLabel.textContent = `${p}%`;
}

/**
 * åœ¨æ—¥èªŒå€åŸŸé¡¯ç¤ºè¨Šæ¯
 * @param {string} msg - è¦é¡¯ç¤ºçš„è¨Šæ¯
 */
function log(msg) {
    logText.innerHTML += msg + '\n';
    logText.scrollTop = logText.scrollHeight; // è‡ªå‹•æ»¾å‹•åˆ°åº•éƒ¨
}

</script>

</body>
</html>
